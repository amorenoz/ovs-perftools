// This bpftrace script prints successfull and errored upcalls per netdev

//Let bpftrace detect btf structs.
// #include <linux/sk_buff.h>

kprobe:ovs_dp_upcall {
 $skb = (struct sk_buff *)arg1;
 $dev = $skb->dev;
 $name = $dev->name;
 @device[tid] = $name;
}

kretprobe:ovs_dp_upcall / retval == 0 && @device[tid] != "" / {
 @success[@device[tid]] = count();
}

kretprobe:ovs_dp_upcall / retval != 0 && @device[tid] != "" / {
 @error[@device[tid]] = count();
}

END {
 clear (@device)
}
